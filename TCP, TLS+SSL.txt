                        Общий процесс установления TCP соединения

Установка TCP соединения:
    Перед тем, как начать SSL/TLS рукопожатие, клиент и сервер должны установить TCP соединение. Это стандартное трехстороннее рукопожатие TCP (SYN, SYN-ACK, ACK).

Пример TCP рукопожатия:

Client              Server
SYN  ------------>
        <------------  SYN-ACK
ACK  ------------>

Инициация SSL/TLS рукопожатия:
    После установления TCP соединения клиент инициирует SSL/TLS рукопожатие, отправляя сообщение ClientHello.

Подробное описание процесса

TCP Рукопожатие (3-way handshake):
    SYN: Клиент отправляет серверу пакет SYN, запрашивая установление соединения.
    SYN-ACK: Сервер отвечает пакетом SYN-ACK, подтверждая запрос клиента и запрашивая подтверждение от клиента.
    ACK: Клиент отправляет серверу пакет ACK, подтверждая получение SYN-ACK, и соединение устанавливается.

SSL/TLS Рукопожатие:
    Как только TCP соединение установлено, клиент начинает SSL/TLS рукопожатие для создания защищенного канала связи.

                        Установка SSL/TLS соединения

Шаги SSL/TLS рукопожатия

ClientHello:
    Клиент отправляет сообщение ClientHello серверу, которое включает:
        Версии протокола SSL/TLS, поддерживаемые клиентом.
        Список поддерживаемых шифров (cipher suites).
        Случайное значение (random value).
        Дополнительные параметры, такие как сессионный идентификатор (session ID).

ServerHello:
    Сервер отвечает сообщением ServerHello, которое включает:
        Выбранную версию протокола SSL/TLS.
        Выбранный шифр (cipher suite) из списка, предложенного клиентом.
        Случайное значение (random value).
        Дополнительные параметры, такие как сессионный идентификатор (session ID).

Server Certificate:
    Сервер отправляет клиенту свой цифровой сертификат, который содержит публичный ключ сервера и информацию о сервере.

Server Key Exchange (не всегда необходим):
    Сервер отправляет дополнительные параметры для ключевого обмена, если это требуется выбранным шифром.

Certificate Request (не всегда необходим):
    Сервер может запросить у клиента сертификат для двухсторонней аутентификации.

Server Hello Done:
    Сервер завершает свою часть рукопожатия, отправляя сообщение Server Hello Done.

Client Key Exchange:
    Клиент генерирует пред-мастер-секрет (pre-master secret) и шифрует его с использованием публичного ключа сервера, затем отправляет его серверу.

Certificate Verify (не всегда необходим):
    Если сервер запросил клиентский сертификат, клиент подписывает часть сообщений рукопожатия своим закрытым ключом и отправляет серверу для проверки.

Создание мастер-секрета (Master Secret):
    Клиент и сервер используют пред-мастер-секрет и случайные значения, обмененные ранее, для создания мастер-секрета (master secret).

Создание ключей сеанса (Session Keys):
    Мастер-секрет используется для создания симметричных ключей для шифрования и аутентификации данных в течение сеанса (AES шифрование, advanced secure algoritm)

Client Finished:
    Клиент отправляет сообщение Finished, содержащее хэш всех предыдущих сообщений рукопожатия, зашифрованное новым симметричным ключом.

Server Finished:
    Сервер отправляет сообщение Finished, содержащее хэш всех предыдущих сообщений рукопожатия, зашифрованное новым симметричным ключом.

Завершение установления соединения

После успешного обмена сообщениями Finished, SSL/TLS рукопожатие завершено, и устанавливается защищенное соединение. Все дальнейшие данные передаются с использованием симметричного шифрования, обеспечивая конфиденциальность и целостность данных.
Полная схема установления соединения


Client                                  Server
   |                                      |
   | ----------- ClientHello ------------>|
   |                                      |
   | <----------- ServerHello ------------|
   |                                      |
   | -------- Server Certificate -------->|
   |                                      |
   | --- Server Key Exchange (optional) -->|
   |                                      |
   | <------ Certificate Request (optional)|
   |                                      |
   | <------- Server Hello Done ----------|
   |                                      |
   | -------- Client Key Exchange ------->|
   |                                      |
   | ---- Certificate Verify (optional) -->|
   |                                      |
   | ----------- Client Finished -------->|
   |                                      |
   | ----------- Server Finished -------->|
   |                                      |
   |          Encrypted Application Data  |
   | <----------------------------------> |

Заключение
Процесс установления SSL/TLS соединения начинается сразу после успешного установления TCP соединения. Этот процесс включает множество шагов, направленных на обеспечение безопасного обмена данными между клиентом и сервером. После завершения рукопожатия, данные передаются с использованием симметричного шифрования, что обеспечивает высокую производительность и безопасность соединения.