        Конвертация хоста с VMWare в PnetLab
        https://www.eve-ng.net/index.php/faq/
        https://www.youtube.com/watch?v=_1gVzM4SnYo&t=190s

Копируем файл диска в папку /opt/unetlab/addons/qemu/название_папки
cd /opt/unetlab/addons/qemu/папка_с_файлом 
qemu-img convert -f vmdk -O qcow2 файл_с_vmware.vmdk hda.qcow2
После этого по идее надо сделать fixpermission
/opt/unetlab/wrappers/unl_wrapper -a fixpermissions

Образ с ключами: 
https://downloaddevtools.com/en/product/18/free-download-vmware-vsphere


                GNS 3

https://github.com/hegdepavankumar/Cisco-Images-for-GNS3-and-EVE-NG - образы cisco для GNS3

        Проблемы с nested virtualization workstation product
Если у вас проблемы с вложенной виртуализацией на VMWare и появляется сообщение об ошибке "VMware Workstation does not support nested virtualization on this host. Module 'HV' power on failed"
 
Исправить её можно выполнив действия ниже:
 
Убедитесь, что безопасность на основе виртуализации (VBS) включена/не включена:
 
1. Откройте msinfo32 (системную информацию в Windows 10).
2. В разделе «Сводка системы» на правой странице прокрутите вниз до «Безопасность на основе виртуализации» и
убедитесь, что для параметра «Значение» установлено значение «Не включено».
3. Если установлено значение «включено», выполните шаги, указанные ниже, в соответствии с отключением Hyper-V.
 
Отключите Hyper-V
Перейдите к пункту «Включение или отключение компонентов Windows».
Убедитесь, что Hyper-v не отмечен галочкой.
Если он отмечен, снимите его и нажмите «ОК».
 
Откройте окно командной строки от имени администратора.
Запустите «bcdedit /enum »
 
Запишите тип запуска гипервизора на случай, если его нужно отменить.
Запустите «bcdedit /set hypervisorlaunchtype off», чтобы отключить гипервизор .
Закройте командную строку после выполнения команд и перезапустите систему.
Также необходимо сделать это: «убедитесь, что целостность памяти отключена.
Безопасность Windows -> Безопасность устройства -> Детали изоляции ядра»

ESXi хосты - реальные сервера на которые устанавливается ESXi (bare-metal virtualization)

Storage - на каждом физ сервере есть локальный жесткий диск 
Можно использовать сетевое хранилище и все физические сервера будут подключаться к нему по технологии ISCSI (internet скази) или по NFS, или по Fiber Channel или по FB over Ethetnet

vCenter - централизованный сервер для управления хостами (физическими). Он может быть физичеким или виртуальным. Это по сути программа, которая устанавливается на WinServer.
VCSA - это линукс версия vCenter устанавливаемая только виртуально (имеет ОС Photon OS, PostgreSQL DB и Platform Services Controller и vCenter Server)

Сеть 
Managment - та сеть через которую мы связываемся с хостами, то есть наша обычная сеть организации 192.168.0.1
Storage - вторая NIC хоста связана по этой отдельной сети с сетевым хранилищем (storage)
vMotion - сеть для миграции виртуалки с одного хоста на другой
VMnetwork - сеть внутри VMWare

В идеале иметь 5 железных серверов: AD, 3 шт bare-metal VMware ESXi , vCenter (установлен на машине с WinServer)

В Hyper-V создаем 5 хостов, и меняем тип адаптера на legasy, так как ESXi 6 не поддерживает совр адаптеры для nested virtualization
Во всех хостах уменьшаем максимальную динамическую память до максимальной для хоста (4096), а для vCenter (9000 - не динамическая!)
Для ESXi ставим 2 ядра, 4 legasy адаптера


Далее создаем свич
External - это bridge
Internal - мой комп и хосты видят друг друга, но выхода в интренет у хостов нет
Private - изолированная сеть для самих машин
Создаем external and private switches
В настроках каждой виртуалки подключаем их к private switch 

Устанавливаем winserver (192.168.1.3) и делаем его контроллером домена и DHCP сервером (192.168.0.100-254)
Установить статические адреса машинам ESXi и дать имена хостов
Создать А-записи для хостов ESXi в DNS контроллера домена



    ESXI 8 vSphere 8 Enterprise Plus

    HG00K-03H8K-48929-8K1NP-3LUJ4 
    4F40H-4ML1K-M89U0-0C2N4-1AKL4

    vCenter Server 8 Standard

    0F41K-0MJ4H-M88U1-0C3N0-0A214

Решение проблемы No healthy upstream vCenter
скачать ssh клмент, подключится и ввести команду, выбрать 8 и сделать новые сертификаты
    https://kb.vmware.com/s/article/2112283

свич

vmnic0 - это первый из 4х адаптеров нашего виртуального хоста ESXi
Он на схеме изображен справа

К этому vmnic0 подключены и Managment Network (на которой и висит ip ESXi) и VM Network (сеть виртуальных машин). Они все в одном широковещат домене и им назначаются IP адреса одной сети.

        Общий Storage
    
Добавляем диск к контролеру домена
Нужно установить роль ISCSI и после установки создать новый iscsi диск, пройти по пунктам создав ISCSI-target и добавить инициаторов (ip который будут обращаться к этому диску)

!! В каждой ESXi создать по свичу (лучше это сделать через VCSA, так как сразу можно добавить VMkernel), и уже через интерфейс каждого ESXi соединить его с сетью (uplink) !! - иначе добавить не получается!

Далее в разделе Storage создаем host base adapter - iSCSI
Связываем его с новым свичем во вкладке Network port binding

Далее там же через вкдалку Static Discovery вводим ip и iscsi-target name хранилища (это имя можно посмотреть в сервер менеджере виндовс сервер во вкладке iSCSI снизу)

В пункт Datastores надо добавить самостоятельно

Если надо расширить диск, то сначала расширяем, затем расширяем том в виндовс, затем в Server Manager на вкладке SCSI - extend,
затем на хостах ESXI во вклдке Storage - properties - increase

        Jбщая NFS шара

Нужно установить роль - Server for NFS
Далее в service manager отурываем File and storage services - shares - new share - NFS share quick

Обзываем шару, указываем место, без аутентиикации и права на чтение\запись

Далее в vCenter ПКМ на ESXi машине - Storage - new Datastorage - NFS

                Migration and vMotion

Должны совпадать процы, ядра (лучше использовать одинаковые сервера)

Миграция - при выключенной машине (всю, только машину, только ресурсы)
вМоушен - при включенной 

        Как создать новый свич

Через vCenter зайти на ESXi хост - configure - networking - virtual switces - add networking... 

VMkernel Network Adapter - New standart switches - выбираем физический адаптер через который мы будем взаимодействовать с нужной сетью - создаем название в графе Network Label (NMkernel Storage или vMotion) - назначаем статический ip
После этого новый свич появится, но он почему-то не будет связан с внешним адаптером, который вы выбирали при создании свича, поэтому нужно зайти на сам хост ESXi через веб-интерфейс - Networking - выбрать нужный свич и сверху Add uplink и связь появится

                Snapshot

При удалени снепшота все его изменения применяются на предыдущий снепшоти

                Удаление VM

Можно удалить from inventory, тогда все файлы останутся там где они хранятся. Чтоюы восстановить надо выбрать файл .vmx и сверху нажать Register VM

Если просто переименовать VM, то название измениться, но название папки, где хранятся все файлы не измеится, чтобы изменить нужно мигрировать только хранилище.

                NIC Teaming

Для опции netttwork failover detection с опцией beacon probing надо использовать 3 адаптера для корректной работы

                        КЛАСТЕРЫ

                DRS (disributes resourse scheduler)
Сначала создаем кластер и добавяем в него все хосты
3 режима:
- ручной (спрашивет)
- полуавтомат (сама распределяет на момент включения вм)
- автомат (мигрирует машины в течение работы туда сюда, в зависимости от текущей загрузки хоста ESXi)

                Affinity Rules (в настройках DRS)

Создать правило, чтобы например vm1 и vm2 находились всегда на одном хосте, или разных
- togethe
- apart 
- only to specific ESXi host
- away from specific ESXi host

                High avaliability

Нужен кластер и общее хранилище
И установленные VmWare tools
Мониторит все это master host посредством heartbits пакетов в сетях MGMT и DATASTORE
Если не может достучаться до VM или хоста, то создает данный машины на другом ESXi хосте
Желательно чтобы на managment интерфейсе было 2 сетевые карты (nic teaming)

Перед переводом хоста в maintance mode нужно в настройках HA отключить monitoring

                iSCSI multipath

Смотреть видео, так как он создает еще один свич и соответственно vmk, хотя сеть та же.
